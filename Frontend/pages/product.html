<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Database Table</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            margin: 40px;
            color: #333;
        }

        h2 {
            color: #2c3e50;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background-color: #fff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            border: 1px solid #e0e0e0;
            padding: 12px;
            text-align: center;
        }

        th {
            background-color: #d1e7dd;
            color: #2d6a4f;
            font-weight: 600;
        }

        .actions button {
            margin: 0 5px;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
            font-weight: 500;
        }

        .add-button {
            background-color: #4caf50;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: background-color 0.2s ease;
        }

        .add-button:hover {
            background-color: #45a049;
        }

        .edit-button {
            background-color: #f4c542;
        }

        .edit-button:hover {
            background-color: #e0b937;
        }

        .delete-button {
            background-color: #e74c3c;
        }

        .delete-button:hover {
            background-color: #d73825;
        }

        #popupForm, #editPopup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px 30px;
            border: 1px solid #ccc;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            border-radius: 10px;
            width: 300px;
            z-index: 10;
        }

        #popupForm input, #editPopup input,
        #popupForm select, #editPopup select {
            margin: 10px 0;
            padding: 10px;
            width: 100%;
            border-radius: 4px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }

        #popupForm button, #editPopup button {
            margin-top: 10px;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
    </style>
</head>
<body>
<h2>Product Database</h2>
<button class="add-button" onclick="showPopup()">ADD PRODUCT</button>
<table>
    <thead>
    <tr>
        <th>Product Name</th>
        <th>Price</th>
        <th>Quantity</th>
        <th>Category</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody id="product-table"></tbody>
</table>

<div id="popupForm">
    <h3>Add Product</h3>
    <input type="text" id="productName" placeholder="Product Name" />
    <input type="number" id="price" placeholder="Price" />
    <input type="number" id="quantity" placeholder="Quantity" />
    <select id="category">
        <option value="">Select Category</option>
    </select>
    <button onclick="addProduct()">Add</button>
    <button onclick="closePopup()">Cancel</button>
</div>

<div id="editPopup">
    <h3>Edit Product</h3>
    <input type="text" id="editName" placeholder="Product Name" />
    <input type="number" id="editPrice" placeholder="Price" />
    <input type="number" id="editQuantity" placeholder="Quantity" />
    <select id="editCategory">
        <option value="">Select Category</option>
    </select>
    <button onclick="updateProduct()">Update</button>
    <button onclick="closeEditPopup()">Cancel</button>
</div>

<script>
    function showPopup() {
        document.getElementById('popupForm').style.display = 'block';
        loadCategories('category'); // Load categories when popup opens
    }

    function closePopup() {
        document.getElementById('popupForm').style.display = 'none';
    }

    function closeEditPopup() {
        document.getElementById('editPopup').style.display = 'none';
    }

    document.addEventListener("DOMContentLoaded", function() {
        loadProducts();
    });

    const apiBaseUrl = "http://localhost:8082/api/v1/products";
    const categoryApiUrl = "http://localhost:8082/api/v1/categories";

    function loadProducts() {
        fetch(`${apiBaseUrl}/getAll`)
            .then(response => response.json())
            .then(products => {
                const table = document.getElementById('product-table');
                table.innerHTML = "";
                products.forEach(product => {
                    let row = table.insertRow();
                    row.insertCell(0).innerText = product.name;
                    row.insertCell(1).innerText = product.price;
                    row.insertCell(2).innerText = product.quantity;
                    row.insertCell(3).innerText = product.category?.name || product.category || 'N/A';
                    row.insertCell(4).innerHTML = `
                        <button class="edit-button" onclick="editRow(this, ${product.id})">EDIT</button>
                        <button class="delete-button" onclick="confirmDelete(${product.id})">DELETE</button>`;
                });
            });
    }

    function loadCategories(selectElementId) {
        fetch(`${categoryApiUrl}/getAll`)
            .then(response => response.json())
            .then(categories => {
                const select = document.getElementById(selectElementId);
                // Keep the first option (Select Category)
                select.innerHTML = '<option value="">Select Category</option>';

                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    select.appendChild(option);
                });
            });
    }

    function addProduct() {
        const product = {
            name: document.getElementById('productName').value,
            price: document.getElementById('price').value,
            quantity: document.getElementById('quantity').value,
            categoryId: document.getElementById('category').value
        };

        if (!product.categoryId) {
            alert('Please select a category');
            return;
        }

        fetch(`${apiBaseUrl}/save`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(product)
        }).then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
            .then(() => {
                closePopup();
                loadProducts();
                // Clear form
                document.getElementById('productName').value = '';
                document.getElementById('price').value = '';
                document.getElementById('quantity').value = '';
                document.getElementById('category').value = '';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error adding product');
            });
    }

    function confirmDelete(id) {
        if (confirm('Are you sure you want to delete this product?')) {
            fetch(`${apiBaseUrl}/delete/${id}`, { method: "DELETE" })
                .then(() => loadProducts());
        }
    }

    let editProductId = null;
    function editRow(button, id) {
        editProductId = id;
        let row = button.parentElement.parentElement;
        document.getElementById('editName').value = row.cells[0].innerText;
        document.getElementById('editPrice').value = row.cells[1].innerText;
        document.getElementById('editQuantity').value = row.cells[2].innerText;

        // Load categories for edit popup
        loadCategories('editCategory');

        // Show popup immediately (category will load async)
        document.getElementById('editPopup').style.display = 'block';

        // The category dropdown will update asynchronously
        // The current category might not be selected immediately
    }

    function updateProduct() {
        const updatedProduct = {
            name: document.getElementById('editName').value,
            price: document.getElementById('editPrice').value,
            quantity: document.getElementById('editQuantity').value,
            categoryId: document.getElementById('editCategory').value
        };

        if (!updatedProduct.categoryId) {
            alert('Please select a category');
            return;
        }

        fetch(`${apiBaseUrl}/update/${editProductId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(updatedProduct)
        }).then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
            .then(() => {
                closeEditPopup();
                loadProducts();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating product');
            });
    }
</script>
</body>
</html>